@using CapstoneBlazorApp.Services
@using CapstoneBlazorApp.Services.Abstractions
@using MudBlazor
@using CapstoneBlazorApp.Models
@using CapstoneBlazorApp.Dtos
@using Microsoft.AspNetCore.Components.Authorization
@inject AbstractLoggerService Logger
@inject NavigationManager Nav
@inject NavigationTracker NavTracker
@inject JobsiteApiService JobsiteApi
@inject AssignmentApiService AssignmentApi

@namespace CapstoneBlazorApp.Components.Pages

@page "/manager/assignments"
@rendermode InteractiveServer

<AuthorizeView>
    <Authorized>
        <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="py-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div class="d-flex align-items-center">
                    <MudText Typo="Typo.h4">Assignments Management</MudText>
                </div>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" 
                          StartIcon="@Icons.Material.Filled.Add"
                          OnClick="OpenCreateAssignmentDialog">
                    Create Assignment
                </MudButton>
            </div>

            <MudGrid Spacing="4">
                <!-- summary -->
                <MudItem xs="12" md="3">
                    <MudCard>
                        <MudCardContent>
                            <div class="d-flex align-items-center">
                                <MudIcon Icon="@Icons.Material.Filled.Assignment" Size="Size.Large" Color="Color.Primary" Class="mr-3" />
                                <div>
                                    <MudText Typo="Typo.h5">@totalCount</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">Total Assignments</MudText>
                                </div>
                            </div>
                        </MudCardContent>
                    </MudCard>
                </MudItem>

                <MudItem xs="12" md="3">
                    <MudCard>
                        <MudCardContent>
                            <div class="d-flex align-items-center">
                                <MudIcon Icon="@Icons.Material.Filled.PlayArrow" Size="Size.Large" Color="Color.Success" Class="mr-3" />
                                <div>
                                    <MudText Typo="Typo.h5">@activeCount</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">Active</MudText>
                                </div>
                            </div>
                        </MudCardContent>
                    </MudCard>
                </MudItem>

                <MudItem xs="12" md="3">
                    <MudCard>
                        <MudCardContent>
                            <div class="d-flex align-items-center">
                                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Large" Color="Color.Info" Class="mr-3" />
                                <div>
                                    <MudText Typo="Typo.h5">@completedCount</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">Completed</MudText>
                                </div>
                            </div>
                        </MudCardContent>
                    </MudCard>
                </MudItem>

                <MudItem xs="12" md="3">
                    <MudCard>
                        <MudCardContent>
                            <div class="d-flex align-items-center">
                                <MudIcon Icon="@Icons.Material.Filled.Schedule" Size="Size.Large" Color="Color.Warning" Class="mr-3" />
                                <div>
                                    <MudText Typo="Typo.h5">@overdueCount</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">Overdue</MudText>
                                </div>
                            </div>
                        </MudCardContent>
                    </MudCard>
                </MudItem>

                <!-- filters -->
                <MudItem xs="12">
                    <MudPaper Class="p-4">
                        <MudText Typo="Typo.h6" GutterBottom="true">Filters</MudText>
                        <MudGrid Spacing="3">
                            <MudItem xs="12" md="3">
                                <MudSelect T="int?" @bind-Value="selectedJobsiteFilter" Label="Jobsite" Variant="Variant.Outlined">
                                    <MudSelectItem Value="@((int?)null)">All Jobsites</MudSelectItem>
                                    @foreach (var jobsite in jobSites)
                                    {
                                        <MudSelectItem Value="@((int?)jobsite.JobsiteId)">@jobsite.Name</MudSelectItem>
                                    }
                                </MudSelect>
                            </MudItem>
                            <MudItem xs="12" md="3">
                                <MudSelect T="string" @bind-Value="selectedStatusFilter" Label="Status" Variant="Variant.Outlined">
                                    <MudSelectItem Value="@("All")">All Statuses</MudSelectItem>
                                    <MudSelectItem Value="@("Active")">Active</MudSelectItem>
                                    <MudSelectItem Value="@("Completed")">Completed</MudSelectItem>
                                    <MudSelectItem Value="@("Overdue")">Overdue</MudSelectItem>
                                </MudSelect>
                            </MudItem>
                            <MudItem xs="12" md="3">
                                <MudSelect T="string" @bind-Value="selectedPriorityFilter" Label="Priority" Variant="Variant.Outlined">
                                    <MudSelectItem Value="@("All")">All Priorities</MudSelectItem>
                                    <MudSelectItem Value="@("Low")">Low</MudSelectItem>
                                    <MudSelectItem Value="@("Medium")">Medium</MudSelectItem>
                                    <MudSelectItem Value="@("High")">High</MudSelectItem>
                                </MudSelect>
                            </MudItem>
                            <MudItem xs="12" md="3">
                                <MudButton Variant="Variant.Filled" Color="Color.Primary" 
                                          OnClick="FilterTheAssignments" FullWidth="true">
                                    Apply Filters
                                </MudButton>
                            </MudItem>
                        </MudGrid>
                    </MudPaper>
                </MudItem>

                <!-- assignments -->
                <MudItem xs="12">
                    <MudPaper Class="p-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <MudText Typo="Typo.h5">Assignments</MudText>
                            <MudButton Variant="Variant.Outlined" Color="Color.Primary" 
                                      StartIcon="@Icons.Material.Filled.Refresh"
                                      OnClick="GetAllAssignments">
                                Refresh
                            </MudButton>
                        </div>

                        @if (loadingStuff)
                        {
                            <MudProgressCircular Indeterminate="true" />
                        }
                        else
                        {
                            <MudTable Items="@displayedAssignments" Hover="true" Dense="true" Striped="true">
                                <HeaderContent>
                                    <MudTh>ID</MudTh>
                                    <MudTh>Title</MudTh>
                                    <MudTh>Jobsite</MudTh>
                                    <MudTh>Assigned User</MudTh>
                                    <MudTh>Due Date</MudTh>
                                    <MudTh>Priority</MudTh>
                                    <MudTh>Status</MudTh>
                                    <MudTh>Actions</MudTh>
                                </HeaderContent>
                                <RowTemplate Context="assignment">
                                    <MudTd DataLabel="ID">@assignment.AssignmentId</MudTd>
                                    <MudTd DataLabel="Title">@assignment.Title</MudTd>
                                    <MudTd DataLabel="Jobsite">
                                        @{
                                            var jobsite = jobSites.FirstOrDefault(j => j.JobsiteId == assignment.JobsiteId);
                                        }
                                        @(jobsite?.Name ?? "Unknown")
                                    </MudTd>
                                    <MudTd DataLabel="Assigned User">@(assignment.AssignedUserId?.ToString() ?? "Unassigned")</MudTd>
                                    <MudTd DataLabel="Due Date">
                                        @if (assignment.DueDate.HasValue)
                                        {
                                            @assignment.DueDate.Value.ToString("MMM dd, yyyy")
                                        }
                                        else
                                        {
                                            <MudText Color="Color.Secondary">No due date</MudText>
                                        }
                                    </MudTd>
                                    <MudTd DataLabel="Priority">
                                        <MudChip T="string" Color="@GetPriorityColor(assignment.Priority ?? "Medium")" Size="Size.Small">
                                            @(assignment.Priority ?? "Medium")
                                        </MudChip>
                                    </MudTd>
                                    <MudTd DataLabel="Status">
                                        <MudChip T="string" Color="@GetStatusColor(assignment)" Size="Size.Small">
                                            @GetAssignmentStatus(assignment)
                                        </MudChip>
                                    </MudTd>
                                    <MudTd DataLabel="Actions">
                                        <MudIconButton Icon="@Icons.Material.Filled.Visibility" 
                                                     Color="Color.Primary" Size="Size.Small"
                                                     OnClick="@(() => ViewAssignmentDetails(assignment))"
                                                     Title="View Details" />
                                        <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                                     Color="Color.Primary" Size="Size.Small"
                                                     OnClick="@(() => EditAssignment(assignment))"
                                                     Title="Edit" />
                                        <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                                     Color="Color.Error" Size="Size.Small"
                                                     OnClick="@(() => DeleteAssignment(assignment))"
                                                     Title="Delete" />
                                    </MudTd>
                                </RowTemplate>
                                <PagerContent>
                                    <MudTablePager PageSizeOptions="new int[]{10, 25, 50}" />
                                </PagerContent>
                            </MudTable>
                        }
                    </MudPaper>
                </MudItem>
            </MudGrid>
        </MudContainer>

        <!-- assignment details / edit -->
        <MudDialog @bind-Visible="dialogIsOpen" Options="dialogOptions">
            <DialogContent>
                <MudText Typo="Typo.h6" GutterBottom="true">
                    @(assignmentBeingEdited != null ? "Edit Assignment" : currentAssignment != null ? "Assignment Details" : "Create Assignment")
                </MudText>
                
                @if (currentAssignment != null && assignmentBeingEdited == null)
                {
                    <!-- View Mode -->
                    <MudGrid Spacing="3">
                        <MudItem xs="12">
                            <MudTextField Label="Title" Value="@currentAssignment.Title" ReadOnly="true" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudTextField Label="Description" Value="@currentAssignment.Description" Lines="3" ReadOnly="true" />
                        </MudItem>
                        <MudItem xs="6">
                            <MudTextField Label="Jobsite" Value="@(jobSites.FirstOrDefault(j => j.JobsiteId == currentAssignment.JobsiteId)?.Name ?? "Unknown")" ReadOnly="true" />
                        </MudItem>
                        <MudItem xs="6">
                            <MudTextField Label="Assigned User" Value="@(currentAssignment.AssignedUserId?.ToString() ?? "Unassigned")" ReadOnly="true" />
                        </MudItem>
                        <MudItem xs="6">
                            <MudTextField Label="Priority" Value="@(currentAssignment.Priority ?? "Medium")" ReadOnly="true" />
                        </MudItem>
                        <MudItem xs="6">
                            <MudTextField Label="Status" Value="@GetAssignmentStatus(currentAssignment)" ReadOnly="true" />
                        </MudItem>
                        <MudItem xs="6">
                            <MudTextField Label="Due Date" Value="@(currentAssignment.DueDate?.ToString("yyyy-MM-dd") ?? "Not set")" ReadOnly="true" />
                        </MudItem>
                        <MudItem xs="6">
                            <MudTextField Label="Created" Value="@(currentAssignment.CreatedAt?.ToString("yyyy-MM-dd HH:mm") ?? "Unknown")" ReadOnly="true" />
                        </MudItem>
                    </MudGrid>
                }
                else
                {
                    <!-- Edit/Create Mode -->
                    <MudGrid Spacing="3">
                        <MudItem xs="12">
                            <MudTextField @bind-Value="titleInput" Label="Title" Required="true" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudTextField @bind-Value="descriptionInput" Label="Description" Lines="3" />
                        </MudItem>
                        <MudItem xs="6">
                            <MudSelect T="int" @bind-Value="selectedJobsiteId" Label="Jobsite" Required="true">
                                @foreach (var jobsite in jobSites)
                                {
                                    <MudSelectItem Value="@jobsite.JobsiteId">@jobsite.Name</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="6">
                            <MudNumericField @bind-Value="selectedUserId" Label="Assigned User ID" />
                        </MudItem>
                        <MudItem xs="6">
                            <MudSelect T="string" @bind-Value="selectedPriority" Label="Priority">
                                <MudSelectItem Value="@("Low")">Low</MudSelectItem>
                                <MudSelectItem Value="@("Medium")">Medium</MudSelectItem>
                                <MudSelectItem Value="@("High")">High</MudSelectItem>
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="6">
                            <MudDatePicker @bind-Date="selectedDueDate" Label="Due Date" />
                        </MudItem>
                    </MudGrid>

                    @if (!string.IsNullOrEmpty(errorMsg))
                    {
                        <MudAlert Severity="Severity.Error" Class="mt-3">@errorMsg</MudAlert>
                    }
                }
            </DialogContent>
            <DialogActions>
                <MudButton OnClick="CloseAssignmentDialog">
                    @(currentAssignment != null && assignmentBeingEdited == null ? "Close" : "Cancel")
                </MudButton>
                @if (currentAssignment != null && assignmentBeingEdited == null)
                {
                    <MudButton Color="Color.Primary" OnClick="@(() => StartEditAssignment(currentAssignment))">
                        Edit
                    </MudButton>
                }
                else if (assignmentBeingEdited != null || currentAssignment == null)
                {
                    <MudButton Color="Color.Primary" Variant="Variant.Filled" 
                              OnClick="SaveAssignment" Disabled="currentlySaving">
                        @if (currentlySaving)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2"/>
                        }
                        @(assignmentBeingEdited != null ? "Update" : "Create")
                    </MudButton>
                }
            </DialogActions>
        </MudDialog>
    </Authorized>
    <NotAuthorized>
        <RedirectToLogin />
    </NotAuthorized>
</AuthorizeView>

@code {
    // for assignments
    private List<AssignmentDto> allAssignments = new();
    private List<AssignmentDto> displayedAssignments = new();
    private List<JobsiteDto> jobSites = new();
    
    private AssignmentDto? currentAssignment;
    private AssignmentDto? assignmentBeingEdited;
    private bool loadingStuff = true;
    private bool dialogIsOpen = false;
    private bool currentlySaving = false;
    private string errorMsg = "";

    // counts 
    private int totalCount = 0;
    private int activeCount = 0;
    private int completedCount = 0;
    private int overdueCount = 0;

    // filters
    private int? selectedJobsiteFilter;
    private string selectedStatusFilter = "All";
    private string selectedPriorityFilter = "All";

    // form
    private string titleInput = "";
    private string descriptionInput = "";
    private int selectedJobsiteId = 0;
    private int? selectedUserId;
    private string selectedPriority = "Medium";
    private DateTime? selectedDueDate;

    private DialogOptions dialogOptions = new() { MaxWidth = MaxWidth.Medium, FullWidth = true };

    protected override async Task OnInitializedAsync()
    {
        // load all when page starts
        await GetJobSites();
        await GetAllAssignments();
    }

    private async Task GetJobSites()
    {
        try
        {
            var stuff = await JobsiteApi.GetAllJobsitesAsync();
            jobSites = stuff?.Select(j => new JobsiteDto
            {
                JobsiteId = j.JobsiteId,
                Name = j.Name,
                Latitude = j.Latitude,
                Longitude = j.Longitude,
                RadiusMeters = j.RadiusMeters,
                CreatedAt = j.CreatedAt,
                UpdatedAt = j.UpdatedAt
            }).ToList() ?? new List<JobsiteDto>();
        }
        catch (Exception ex)
        {
            Logger.Log(this, $"uh oh cant load jobsites: {ex.Message}", "error");
        }
    }

    private async Task GetAllAssignments()
    {
        try
        {
            loadingStuff = true;
            
            // get the jobsite ids so we can get assignments for them
            var jobsiteIdsList = jobSites.Select(j => j.JobsiteId).ToList();
            
            if (jobsiteIdsList.Any())
            {
                var assignmentData = await AssignmentApi.GetAllAssignmentsAsync(jobsiteIdsList);
                allAssignments = assignmentData?.Select(a => new AssignmentDto
                {
                    AssignmentId = a.AssignmentId,
                    Title = a.Title,
                    Description = a.Description,
                    JobsiteId = a.JobsiteId,
                    AssignedUserId = a.AssignedUserIds?.FirstOrDefault(), // just take the first one i guess
                    Priority = "Medium", // api doesnt have this so just default it
                    DueDate = null, // this too
                    CreatedAt = a.CreatedAt,
                    UpdatedAt = a.UpdatedAt
                }).ToList() ?? new List<AssignmentDto>();
            }
            else
            {
                allAssignments = new List<AssignmentDto>(); // no jobsites = no assignments
            }
            
            FilterTheAssignments();
            DoTheStatsCounting();
            
            Logger.Log(this, $"got {allAssignments.Count} assignments loaded", "info");
        }
        catch (Exception ex)
        {
            Logger.Log(this, $"assignments loading broke: {ex.Message}", "error");
            allAssignments = new List<AssignmentDto>(); // fallback to empty
        }
        finally
        {
            loadingStuff = false;
            StateHasChanged(); // tell blazor to update
        }
    }



    private void FilterTheAssignments()
    {
        displayedAssignments = allAssignments.Where(assignment =>
        {
            // check jobsite first
            if (selectedJobsiteFilter.HasValue && assignment.JobsiteId != selectedJobsiteFilter.Value)
                return false;

            // status
            if (selectedStatusFilter != "All" && GetAssignmentStatus(assignment) != selectedStatusFilter)
                return false;

            // priority check
            if (selectedPriorityFilter != "All" && (assignment.Priority ?? "Medium") != selectedPriorityFilter)
                return false;

            return true; // passes all filters
        }).ToList();

        StateHasChanged(); // make sure ui updates
    }

    private void DoTheStatsCounting()
    {
        totalCount = allAssignments.Count;
        activeCount = allAssignments.Count(a => GetAssignmentStatus(a) == "Active");
        completedCount = allAssignments.Count(a => GetAssignmentStatus(a) == "Completed");
        overdueCount = allAssignments.Count(a => GetAssignmentStatus(a) == "Overdue");
    }

    private string GetAssignmentStatus(AssignmentDto assignment)
    {
        if (!assignment.DueDate.HasValue)
            return "Active";

        var now = DateTime.Now.Date;
        if (assignment.DueDate.Value.Date < now)
            return "Overdue";
        
        // For demo purposes, randomly assign some as completed
        return assignment.AssignmentId % 4 == 0 ? "Completed" : "Active";
    }

    private Color GetStatusColor(AssignmentDto assignment)
    {
        return GetAssignmentStatus(assignment) switch
        {
            "Active" => Color.Success,
            "Completed" => Color.Info,
            "Overdue" => Color.Error,
            _ => Color.Default
        };
    }

    private Color GetPriorityColor(string priority)
    {
        return priority switch
        {
            "Low" => Color.Success,
            "Medium" => Color.Warning,
            "High" => Color.Error,
            _ => Color.Default
        };
    }

    private void OpenCreateAssignmentDialog()
    {
        Logger.Log(this, "OpenCreateAssignmentDialog called", "info");
        selectedAssignment = null;
        editingAssignment = null;
        ClearFormFields();
        errorMessage = "";
        showAssignmentDialog = true;
        Logger.Log(this, $"showAssignmentDialog set to: {showAssignmentDialog}", "info");
        StateHasChanged();
    }

    private void ViewAssignmentDetails(AssignmentDto assignment)
    {
        selectedAssignment = assignment;
        editingAssignment = null;
        showAssignmentDialog = true;
    }

    private void EditAssignment(AssignmentDto assignment)
    {
        StartEditAssignment(assignment);
    }

    private void StartEditAssignment(AssignmentDto assignment)
    {
        editingAssignment = assignment;
        selectedAssignment = assignment;
        LoadFormFields(assignment);
        errorMessage = "";
    }

    private void CloseAssignmentDialog()
    {
        showAssignmentDialog = false;
        selectedAssignment = null;
        editingAssignment = null;
        ClearFormFields();
        errorMessage = "";
    }

    private void ClearFormFields()
    {
        assignmentTitle = "";
        assignmentDescription = "";
        assignmentJobsiteId = jobsites.FirstOrDefault()?.JobsiteId ?? 0;
        assignmentUserId = null;
        assignmentPriority = "Medium";
        assignmentDueDate = null;
    }

    private void LoadFormFields(AssignmentDto assignment)
    {
        assignmentTitle = assignment.Title ?? "";
        assignmentDescription = assignment.Description ?? "";
        assignmentJobsiteId = assignment.JobsiteId;
        assignmentUserId = assignment.AssignedUserId;
        assignmentPriority = assignment.Priority ?? "Medium";
        assignmentDueDate = assignment.DueDate;
    }

    private async Task SaveAssignment()
    {
        if (string.IsNullOrWhiteSpace(titleInput))
        {
            errorMsg = "Title is required";
            return;
        }

        if (selectedJobsiteId == 0)
        {
            errorMsg = "Please select a jobsite";
            return;
        }

        try
        {
            currentlySaving = true;
            errorMsg = "";

            if (assignmentBeingEdited != null)
            {
                // updating existing one
                var updateRequest = new AssignmentUpdateRequest
                {
                    Title = titleInput,
                    Description = descriptionInput,
                    AssignedUserIds = selectedUserId.HasValue ? new List<int> { selectedUserId.Value } : null
                };

                var success = await AssignmentApi.UpdateAssignmentAsync(assignmentBeingEdited.AssignmentId, updateRequest);
                if (success)
                {
                    Logger.Log(this, $"updated assignment: {titleInput}", "info");
                }
                else
                {
                    errorMsg = "Failed to update assignment";
                    return;
                }
            }
            else
            {
                // making new one
                var createRequest = new AssignmentCreateRequest
                {
                    Title = titleInput,
                    Description = descriptionInput,
                    JobsiteId = selectedJobsiteId,
                    AssignedUserIds = selectedUserId.HasValue ? new List<int> { selectedUserId.Value } : null
                };

                var success = await AssignmentApi.CreateAssignmentAsync(createRequest);
                if (success)
                {
                    Logger.Log(this, $"created new assignment: {titleInput}", "info");
                }
                else
                {
                    errorMsg = "Failed to create assignment";
                    return;
                }
            }

            dialogIsOpen = false;
            await GetAllAssignments(); // refresh everything
        }
        catch (Exception ex)
        {
            Logger.Log(this, $"something broke when saving: {ex.Message}", "error");
            errorMsg = $"Error: {ex.Message}";
        }
        finally
        {
            currentlySaving = false;
            StateHasChanged(); // make sure ui updates
        }
    }

    private async Task DeleteAssignment(AssignmentDto assignment)
    {
        try
        {
            var success = await AssignmentApi.DeleteAssignmentAsync(assignment.AssignmentId);
            if (success)
            {
                Logger.Log(this, $"Deleted assignment: {assignment.Title}", "info");
                await GetAllAssignments(); // Refresh the list
            }
            else
            {
                Logger.Log(this, $"Failed to delete assignment: {assignment.Title}", "error");
            }
        }
        catch (Exception ex)
        {
            Logger.Log(this, $"Error deleting assignment: {ex.Message}", "error");
        }
    }

    private void GoBack()
    {
        if (!NavTracker.IsEmpty())
        {
            var previousUri = NavTracker.Pop();
            Nav.NavigateTo(previousUri);
        }
    }
}
