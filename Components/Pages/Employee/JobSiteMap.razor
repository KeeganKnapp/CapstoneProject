@using CapstoneBlazorApp.Services.Abstractions
@using Microsoft.JSInterop
@using CapstoneBlazorApp.Models
@using MudBlazor
@inject IJSRuntime JS
@inject AbstractLoggerService Logger
@implements IAsyncDisposable

@namespace CapstoneBlazorApp.Components.Pages

<!-- Interactive Job Site Map -->
<div id="@_id" style="height: 100%; width: 100%; min-height: 300px; border-radius: 4px; overflow: hidden;"></div>


@code {    [Parameter] public int currentSiteId { get; set; } = 0;
    [Parameter] public IEnumerable<SiteDto>? Sites { get; set; }
    [Parameter] public EventCallback<SiteDto> OnChanged { get; set; }
    bool initialized = false;
    private int previousSiteId = 0;
    string _id = $"map_{Guid.NewGuid():N}";
    DotNetObjectReference<JobSiteMap>? _ref;    private async Task FocusOnJobSite(int siteId)
    {
        try
        {
            Logger.Log(this,$"Focusing on job site: {siteId}");
            if(siteId == 0 || !initialized) return;
            await JS.InvokeVoidAsync("capstoneMap.focusOnLocation", siteId);
        }
        catch (Exception ex)
        {
            Logger.Log(this, $"Error focusing on job site: {ex.Message}", "error");
        }
    }   
    private async Task InitializeMap()
    {
    const int maxRetries = 5;
    int retryCount = 0;
        while (retryCount < maxRetries && !initialized)
        {
            try
            {
                Logger.Log(this, $"Initializing JobSiteMap attempt {retryCount + 1} with ID: {_id}");

                // Longer delay for first attempt
                await Task.Delay(retryCount == 0 ? 500 : 200);

                _ref = DotNetObjectReference.Create(this);
                await JS.InvokeVoidAsync("capstoneMap.init", $"#{_id}", _ref, Sites ?? Array.Empty<SiteDto>());
                initialized = true;

                if (currentSiteId != 0)
                {
                    await FocusOnJobSite(currentSiteId);
                }

                Logger.Log(this, "Map initialized successfully");
                break;
            }
            catch (Exception ex)
            {
                retryCount++;
                Logger.Log(this, $"Error initializing map (attempt {retryCount}): {ex.Message}", "error");

                if (retryCount >= maxRetries)
                {
                    Logger.Log(this, "Failed to initialize map after all retries", "error");
                    initialized = false;
                }
            }
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        Logger.Log(this, $"JobSiteMap OnAfterRenderAsync firstRender={firstRender}, initialized={initialized}");

        // Always try to initialize if not already initialized
        if (!initialized)
        {
            await InitializeMap();
        }
        else if (firstRender && currentSiteId != 0)
        {
            await FocusOnJobSite(currentSiteId);
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        Logger.Log(this, $"JobSiteMap OnParametersSetAsync previousSiteId={previousSiteId} currentSiteId={currentSiteId} initialized={initialized}");

        if (initialized && previousSiteId != currentSiteId)
        {
            await FocusOnJobSite(currentSiteId);
            previousSiteId = currentSiteId;
        }
        else if (!initialized && currentSiteId != 0)
        {
            previousSiteId = currentSiteId;
        }
    }

    [JSInvokable]
    public async Task OnSiteChanged(SiteDto site)
    {
        if (OnChanged.HasDelegate)
        {
            await OnChanged.InvokeAsync(site);
        }
    }
    public async ValueTask DisposeAsync()
    {
        try
        {
            Logger.Log(this, $"Disposing JobSiteMap initialized={initialized}");

            if (initialized)
            {
                await JS.InvokeVoidAsync("capstoneMap.dispose");
                initialized = false;
            }

            if (_ref is not null)
            {
                _ref.Dispose();
                _ref = null;
            }
        }
        catch (Exception ex)
        {
            Logger.Log(this, $"Error during JobSiteMap disposal: {ex.Message}", "error");
        }
    }

}
