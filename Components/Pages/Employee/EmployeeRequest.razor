@using CapstoneBlazorApp.Dtos
@using MudBlazor
@using CapstoneBlazorApp.Services.Abstractions
@using CapstoneBlazorApp.Models
@using CapstoneBlazorApp.Services
@using CapstoneBlazorApp.Services.Auth
@using Microsoft.AspNetCore.Components.Authorization

@inject AbstractLoggerService Logger
@inject RequestOffApiService RequestOffApi
@inject IAuthService AuthService
@inject CustomAuthenticationStateProvider AuthStateProvider
@inject NavigationManager Nav
@namespace CapstoneBlazorApp.Components.Pages
@page "/employee-request"
@rendermode InteractiveServer

<AuthorizeView>
    <Authorized>
        <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="py-4">
        <MudGrid Justify="Justify.Center" >
            <MudItem xs="3">
                <MudPaper Class="p-4 justify-center" Elevation="2">
                    <MudText Typo="Typo.h5" Color="Color.Primary">Submit Time Off Request</MudText>

                    <!-- Error/Status Messages -->
                    @if (!string.IsNullOrEmpty(statusMessage))
                    {
                        <MudAlert Severity="@statusSeverity" Class="mb-4" Style="max-width: 400px;">
                            @statusMessage
                        </MudAlert>
                    }

                    <!-- Form Fields -->
                    <MudDatePicker Label="Start Date" @bind-Date="_startDate" Editable="true" ShowToolbar="false"
                        MinDate="DateTime.Today" HelperText="Select the first day of your time off"
                        Style="width: 300px;" Error="@startDateError" ErrorText="@startDateErrorText" />

                    <MudDatePicker Label="End Date" @bind-Date="_endDate" Editable="true" ShowToolbar="false"
                        MinDate="DateTime.Today" HelperText="Select the last day of your time off" Style="width: 300px;"
                        Error="@endDateError" ErrorText="@endDateErrorText" />

                    <MudTextField T="string" @bind-Value="_details" Label="Reason for Time Off"
                        Variant="Variant.Outlined" Style="width: 300px;"
                        HelperText="Brief description of your time off request" Error="@reasonError"
                        ErrorText="@reasonErrorText" />

                    <MudButton Disabled="@submitting" OnClick="@SubmitTimeOffRequest" Variant="Variant.Filled"
                        Color="Color.Primary" Style="width: 300px;" StartIcon="@Icons.Material.Filled.Send">
                        @if (submitting)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            <text>Submitting...</text>
                        }
                        else
                        {
                            <text>Submit Time Off Request</text>
                        }
                    </MudButton>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" Style="overflow-x: auto;">
                    <MudTable Items="@requests" Breakpoint="Breakpoint.None" Hover="true" Dense="true">
                        <ToolBarContent>
                            <MudText Typo="Typo.h6">Your Time Off Requests</MudText>
                            <MudSpacer />
                            <MudChip T="string" Color="Color.Info" Size="Size.Small">@requests.Count requests</MudChip>
                        </ToolBarContent>
                        <HeaderContent>
                            <MudTh>Start Date</MudTh>
                            <MudTh>End Date</MudTh>
                            <MudTh>Days</MudTh>
                            <MudTh>Reason</MudTh>
                            <MudTh>Status</MudTh>
                            <MudTh>Actions</MudTh>
                        </HeaderContent>
                        <RowTemplate Context="request">
                            <MudTd DataLabel="Start">@request.StartDate.ToString("MMM dd, yyyy")</MudTd>
                            <MudTd DataLabel="End">@request.EndDate.ToString("MMM dd, yyyy")</MudTd>
                            <MudTd DataLabel="Days">@((request.EndDate.ToDateTime(TimeOnly.MinValue) -
                                                                request.StartDate.ToDateTime(TimeOnly.MinValue)).Days + 1)</MudTd>
                            <MudTd DataLabel="Reason">@request.Note</MudTd>
                            <MudTd DataLabel="Status">
                                <MudChip T="string" Color="@GetStatusColor(request)" Size="Size.Small">
                                    @GetStatusText(request)
                                </MudChip>
                            </MudTd>
                            <MudTd DataLabel="Actions">
                                <MudButton Size="Size.Small" Color="Color.Error" Variant="Variant.Text"
                                    StartIcon="@Icons.Material.Filled.Delete"
                                    OnClick="@(() => DeleteRequest(request.RequestOffId))">
                                    Delete
                                </MudButton>
                            </MudTd>
                        </RowTemplate>

                        <NoRecordsContent>
                            <MudText Typo="Typo.body1" Color="Color.Secondary">No time off requests found. Submit your
                                first request above!</MudText>
                        </NoRecordsContent>
                    </MudTable>
            </MudItem>
        </MudGrid>
        </MudContainer>

    </Authorized>
    <NotAuthorized>
        <RedirectToLogin />
    </NotAuthorized>
</AuthorizeView>

@code {
    private bool submitting = false;
    private string _details = string.Empty;
    private DateTime? _startDate;
    private DateTime? _endDate;
    
    // Validation and status fields
    private string statusMessage = string.Empty;
    private Severity statusSeverity = Severity.Info;
    private bool startDateError = false;
    private string startDateErrorText = string.Empty;
    private bool endDateError = false;
    private string endDateErrorText = string.Empty;
    private bool reasonError = false;
    private string reasonErrorText = string.Empty;private List<RequestOffDto> requests = new();    protected override async Task OnInitializedAsync()
    {
        await LoadRequests();
    }    
    private async Task LoadRequests()
    {
        try
        {
            Logger.Log(this, "Starting to load requests...", "info");
            var userId = await AuthStateProvider.GetCurrentUserIdAsync();
            if(userId == null){
                Logger.Log(this, "User ID is null - cannot load requests", "error");
                requests = new List<RequestOffDto>();
                return;
            }
            var data = await RequestOffApi.GetRequestsByUserIdAsync(userId.Value);
            Logger.Log(this, $"API returned: {data?.Count ?? 0} requests", "info");
            
            if (data != null)
            {
                requests = data;
                Logger.Log(this, $"Loaded {requests.Count} time-off requests", "info");
            }
            else
            {
                Logger.Log(this, "Failed to load requests from API", "warning");
                requests = new List<RequestOffDto>();
            }
        }
        catch (Exception ex)
        {
            Logger.Log(this, $"Error loading requests: {ex.Message}", "error");
            requests = new List<RequestOffDto>();
        }
        
        Logger.Log(this, $"Final requests count: {requests.Count}", "info");
        StateHasChanged();
    }    
    private void ClearValidationErrors()
    {
        startDateError = false;
        startDateErrorText = string.Empty;
        endDateError = false;
        endDateErrorText = string.Empty;
        reasonError = false;
        reasonErrorText = string.Empty;
        statusMessage = string.Empty;
    }

    private bool ValidateForm()
    {
        ClearValidationErrors();
        bool isValid = true;

        // Validate start date
        if (!_startDate.HasValue)
        {
            startDateError = true;
            startDateErrorText = "Start date is required";
            isValid = false;
        }
        else if (_startDate.Value.Date < DateTime.Today)
        {
            startDateError = true;
            startDateErrorText = "Start date cannot be in the past";
            isValid = false;
        }

        // Validate end date
        if (!_endDate.HasValue)
        {
            endDateError = true;
            endDateErrorText = "End date is required";
            isValid = false;
        }
        else if (_endDate.Value.Date < DateTime.Today)
        {
            endDateError = true;
            endDateErrorText = "End date cannot be in the past";
            isValid = false;
        }
        else if (_startDate.HasValue && _endDate.Value < _startDate.Value)
        {
            endDateError = true;
            endDateErrorText = "End date must be on or after start date";
            isValid = false;
        }

        // Validate reason
        if (string.IsNullOrWhiteSpace(_details))
        {
            reasonError = true;
            reasonErrorText = "Reason is required";
            isValid = false;
        }
        else if (_details.Trim().Length < 3)
        {
            reasonError = true;
            reasonErrorText = "Reason must be at least 3 characters";
            isValid = false;
        }

        return isValid;
    }    private async Task SubmitTimeOffRequest()
    {
        if (submitting) return;
        
        submitting = true;
        ClearValidationErrors();

        try
        {
            // Validate form
            if (!ValidateForm())
            {
                statusMessage = "Please correct the errors above";
                statusSeverity = Severity.Error;
                StateHasChanged();
                return;
            }

            var req = new RequestOffCreateDto(
                DateOnly.FromDateTime(_startDate!.Value),
                DateOnly.FromDateTime(_endDate!.Value),
                _details.Trim()
            );

            var result = await RequestOffApi.CreateRequestAsync(req);

            if (result != null)
            {
                Logger.Log(this, "Time Off Request Submitted Successfully", "success");
                
                // Show success message
                statusMessage = "Time off request submitted successfully!";
                statusSeverity = Severity.Success;
                
                // Clear the form
                _startDate = null;
                _endDate = null;
                _details = string.Empty;
                
                // Reload the requests list
                await LoadRequests();
            }
            else
            {
                statusMessage = "Failed to submit request. Please try again.";
                statusSeverity = Severity.Error;
                Logger.Log(this, "Time Off Request failed - please try again", "error");
            }
        }
        catch (Exception ex)
        {
            statusMessage = $"Error: {ex.Message}";
            statusSeverity = Severity.Error;
            Logger.Log(this, $"Error submitting time off request: {ex.Message}", "error");
        }
        finally
        {
            submitting = false;
            StateHasChanged();
        }
    }

    private async Task DeleteRequest(long requestId)
    {
        try
        {
            var success = await RequestOffApi.DeleteRequestAsync(requestId);
            if (success)
            {
                Logger.Log(this, "Request deleted successfully", "success");
                await LoadRequests(); // Reload the list
            }
            else
            {
                Logger.Log(this, "Failed to delete request", "error");
            }
        }
        catch (Exception ex)
        {
            Logger.Log(this, $"Error deleting request: {ex.Message}", "error");
        }
    }

    private string GetStatusText(RequestOffDto request)
    {
        if (request.Status != null){
            return request.Status;
        }else{
            return "Pending";
        }
        
    }

    private Color GetStatusColor(RequestOffDto request)
    {
        return GetStatusText(request) switch
        {
            "Pending" => Color.Warning,
            "Approved" => Color.Success,
            "Denied" => Color.Error,
            _ => Color.Default
        };
    }

}
