@using CapstoneBlazorApp.Dtos
@using MudBlazor
@using CapstoneBlazorApp.Services.Abstractions
@using CapstoneBlazorApp.Models
@using CapstoneBlazorApp.Services
@using CapstoneBlazorApp.Dtos

@inject AbstractLoggerService Logger
@inject HttpClient http
@inject NavigationManager Nav

@page "/employee-request"


<MudStack AlignItems="AlignItems.Center" Justify="Justify.SpaceEvenly" Style="height: 100vh; overflow: hidden;">   
<MudSelect T="string" Label="Request Type" @bind-Value="selectedRequestType" Style="width: 300px;">
    <MudSelectItem Value="@("time-off")">Time Off</MudSelectItem>
    <MudSelectItem Value="@("shift-change")">Shift Change</MudSelectItem>
    <MudSelectItem Value="@("other")">Other</MudSelectItem>
</MudSelect>


@if (selectedRequestType == "time-off")
{
    <MudDatePicker Label="Start Date" @bind-Date="_startDate" Editable="true" ShowToolbar="false" />
    <MudDatePicker Label="End Date" @bind-Date="_endDate" Editable="true" ShowToolbar="false" />
    <MudTextField T="string" Label="Reason for Time Off" Variant="Variant.Outlined" Style="width: 300px;" />
}
else if (selectedRequestType == "shift-change")
{
    <MudTextField T="string" Label="Current Shift Details" Variant="Variant.Outlined" Style="width: 300px;" />
    <MudTextField T="string" Label="Requested Shift Details" Variant="Variant.Outlined" Style="width: 300px;" />
    <MudTextField T="string" Label="Reason for Shift Change" Variant="Variant.Outlined" Style="width: 300px;" />
}
else if (selectedRequestType == "other")
{
    <MudTextField T="string" @bind-Value="_details" Label="Request Details" Variant="Variant.Outlined" Style="width: 300px;" />
}

@if(selectedRequestType != "Select")
{
    <MudButton Disabled="@submitting" OnClick="@SubmitRequest" Variant="Variant.Filled" Color="Color.Secondary" Style="width: 300px;">
        Submit Request
    </MudButton>
}

<MudTable Style="width: 100%;" Items="@requests" Breakpoint="Breakpoint.None" Elevation="1" Bordered="true" Hover="true">
    <HeaderContent>
        <MudTh>Start Date</MudTh>
        <MudTh>End Date</MudTh>
    </HeaderContent>

    <RowTemplate>
        <MudTd>@context.StartDate.ToString("d")</MudTd>
        <MudTd>@context.EndDate.ToString("d")</MudTd>
    </RowTemplate>
</MudTable>


</MudStack>

@code {
    private string selectedRequestType = "time-off";    

    private bool submitting = false;
    private string _details;
    private DateTime? _startDate;
    private DateTime? _endDate;

    private List<RequestOffDto> requests = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadRequests();
    }
    private async Task LoadRequests()
    {
    	/*
        var token = await SecureStorage.Default.GetAsync("auth_token");
        if (string.IsNullOrEmpty(token))
        {
            Logger.Log(this, "No auth token found. Please log in again.", "error");
            return;
        }

        http.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);

        using var res = await http.GetAsync($"api/requestoff/all");
        if (!res.IsSuccessStatusCode)
        {
            var body = await res.Content.ReadAsStringAsync();
            Logger.Log(this, "Failed to load requests: " + body, "error");
            return;
        }

        var data = await res.Content.ReadFromJsonAsync<List<RequestOffDto>>();
        if (data != null)
        {
            requests = data;
        }

        StateHasChanged();
	*/
    }

    private async Task SubmitRequest()
    {
        if (submitting) return;
        submitting = true;
        try {
        if (selectedRequestType == "time-off")
        {
            await SubmitTimeOffRequest();
        }
        else if (selectedRequestType == "shift-change")
        {
            await SubmitShiftChangeRequest();
        }
        else if (selectedRequestType == "other")
        {
            await SubmitOtherRequest();
        }
        }
        catch (Exception ex)
        {
            Logger.Log(this, "Error submitting request: " + ex.Message, "error");
        }
        finally
        {
            submitting = false;
            await LoadRequests();
        }
    }

    async Task SubmitTimeOffRequest()
    {
        if(_startDate == null || _endDate == null)
        {
            Logger.Log(this, "Start Date and End Date must be provided for Time Off request.", "error");
            return;
        }

	/*
        var token = await SecureStorage.Default.GetAsync("auth_token");
        if(string.IsNullOrEmpty(token))
        {
            Logger.Log(this, "No auth token found. Please log in again.", "error");
            return;
        }

        http.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);

        var req = new RequestOffCreateDto(
        DateOnly.FromDateTime(_startDate.Value),
        DateOnly.FromDateTime(_endDate.Value),
        _details
        );

        using var res = await http.PostAsJsonAsync("api/RequestOff", req);

        if (!res.IsSuccessStatusCode)
        {
            var body = await res.Content.ReadAsStringAsync();
            Logger.Log(this, "Time Off Request failed: " + body, "error");
            return;
        }
	*/
        Logger.Log(this, "Time Off Request Submitted Successfully");
    }
    async Task SubmitShiftChangeRequest()
    {
        // Logic to submit shift change request
        Logger.Log(this, $"Shift Change Request Submitted: Details: {_details}");
    }

    async Task SubmitOtherRequest()
    {
        // Logic to submit other request
        Logger.Log(this, $"Other Request Submitted: Details: {_details}");
    }

}
