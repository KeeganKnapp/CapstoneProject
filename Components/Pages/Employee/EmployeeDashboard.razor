@using CapstoneBlazorApp.Services
@using CapstoneBlazorApp.Services.Abstractions
@using MudBlazor
@using MudBlazor.Components
@using CapstoneBlazorApp.Models
@inject AbstractLoggerService Logger
@inject LocationManager LocationManager
@inject NavigationManager Nav
@inject NavigationTracker NavigationTracker

@namespace CapstoneBlazorApp.Components.Pages

@page "/employee-dashboard"
@rendermode InteractiveServer

<MudContainer MaxWidth="MaxWidth.Large" Style="height: 100vh; padding: 16px;">
    <MudGrid Justify="Justify.Center" AlignItems="Center" Style="height: 100%;">
        
        <!-- Job Site Selection -->
        <MudItem xs="12" sm="8" md="6">
            <MudSelect T="Guid" @bind-Value="selectedSite" Label="Select Job Site" 
                      Variant="Variant.Outlined" FullWidth="true" Margin="Margin.Dense">
                <MudSelectItem Value="@sites[0].Id">Downtown Construction Site</MudSelectItem>
                <MudSelectItem Value="@sites[1].Id">Uptown Renovation Project</MudSelectItem>
                <MudSelectItem Value="@sites[2].Id">Suburban Housing Development</MudSelectItem>
            </MudSelect>
        </MudItem>

        <!-- Map/ToDo Section - Dynamic spacing -->
        <MudItem xs="12" Style="flex-grow: 1; min-height: 0;">
            @if(!clockedIn) {
                <MudCard Elevation="2" Style="height: 100%; width: 100%;">
                    <MudCardContent Style="height: 100%; padding: 0;">
                        <JobSiteMap currentSiteId="@selectedSite" Sites="@sites" OnChanged="@HandleSiteChanged" />
                    </MudCardContent>
                </MudCard>
            }
            else {
                <MudCard Elevation="2" Style="height: 100%; width: 100%;">
                    <MudCardContent Style="height: 100%;">
                        <ToDo/>
                    </MudCardContent>
                </MudCard>
            }
        </MudItem>

        <!-- Hours Worked Display -->
        <MudItem xs="12" Class="text-center">
            <MudText Typo="Typo.h6" Color="Color.Primary">Hours Worked: @hoursWorked</MudText>
        </MudItem>

        <!-- Clock In/Out Button -->
        <MudItem xs="12" sm="8" md="6">
            @if (clockedIn)
            {
                <MudButton Variant="Variant.Filled" FullWidth="true" Color="Color.Error" 
                          Size="Size.Large" OnClick="ClockOut">
                    <MudIcon Icon="@Icons.Material.Filled.AccessTime" Class="mr-2"/>
                    Clock Out
                </MudButton>
            }
            else {
                @if(isClockingIn)
                {
                    <MudButton Disabled="true" Variant="Variant.Filled" FullWidth="true" 
                              Color="Color.Success" Size="Size.Large">
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2"/>
                        Clocking In...
                    </MudButton>
                }
                else
                {
                    <MudButton Variant="Variant.Filled" FullWidth="true" Color="Color.Success" 
                              Size="Size.Large" OnClick="ClockIn">
                        <MudIcon Icon="@Icons.Material.Filled.AccessTime" Class="mr-2"/>
                        Clock In
                    </MudButton>
                }
            }
        </MudItem>

        <!-- Action Buttons - Evenly spaced -->
        <MudItem xs="12">
            <MudGrid Justify="Justify.SpaceEvenly" AlignItems="Center">
                <MudItem xs="4" sm="3" md="2" Class="text-center">
                    <MudButton Variant="Variant.Outlined" Color="Color.Info" 
                              Size="Size.Large" FullWidth="true" OnClick="EmployeePayroll"
                              StartIcon="@Icons.Material.Filled.AccountBalanceWallet">
                        Payroll
                    </MudButton>
                </MudItem>
                
                <MudItem xs="4" sm="3" md="2" Class="text-center">
                    <MudButton Variant="Variant.Outlined" Color="Color.Primary" 
                              Size="Size.Large" FullWidth="true" OnClick="EmployeeRequest"
                              StartIcon="@Icons.Material.Filled.RequestPage">
                        Request
                    </MudButton>
                </MudItem>
                
                <MudItem xs="4" sm="3" md="2" Class="text-center">
                    <MudButton Variant="Variant.Outlined" Color="Color.Warning" 
                              Size="Size.Large" FullWidth="true" OnClick="EmployeeNotifications"
                              StartIcon="@Icons.Material.Filled.Notifications">
                        Notifications
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudItem>

    </MudGrid>
</MudContainer>


@code {
    private bool clockedIn = false;
    private bool isClockingIn = false;
    private double currentLatitude = 47.6062;
    private double currentLongitude = -122.3321;

    private Guid selectedSite = Guid.Empty;
    public List<SiteDto> sites = new()
    {
        new SiteDto(Guid.NewGuid(), "Downtown Construction Site",41.1450, -81.3416, 100),
        new SiteDto(Guid.NewGuid(), "Uptown Renovation Project", 47.6205, -122.3493, 150),
        new SiteDto(Guid.NewGuid(), "Suburban Housing Development", 47.5301, -122.0326, 200)
    };

    private void EmployeeRequest()
    {
        NavigationTracker.Push(Nav.Uri);
        Nav.NavigateTo("/employee-request");
    }

    private void EmployeeNotifications()
    {
        NavigationTracker.Push(Nav.Uri);
        Nav.NavigateTo("/employee-notifications");
    }

    private void EmployeePayroll()
    {
        NavigationTracker.Push(Nav.Uri);
        Nav.NavigateTo("/employee-payroll");
    }

   private void HandleSiteChanged(SiteDto site)
   {
       //handle site change
       SaveSite(this, site);
   }

   public void SaveSite(object? sender, SiteDto site)
   {
       //handle site change
       Logger.Log(this, $"Site changed to: {site.Name}");
  }

    private int hoursWorked = 0;
    private async Task ClockIn()
    {
        isClockingIn = true;
        try {
        var site = sites.First(s => s.Id == selectedSite);
        Logger.Log(this,$"Attempting to clock in at location: {currentLatitude}, {currentLongitude}");
        //basic clock in, implement check for actual clock in later
        //check current location against job site
        if(selectedSite == Guid.Empty)
        {
            //no site selected
            Logger.Log(this, "No job site selected", "error");
            return;
        }
        if (await LocationManager.IsWithinRadiusAsync(site.Lat, site.Lng, site.RadiusMeters))
        {
            clockedIn = true;
            Logger.Log(this, "Clocked in successfully", "info");
        }
        else
        {
            Logger.Log(this, "Not within radius of job site", "error");
        }
        }
        catch(Exception ex)
        {
            Logger.Log(this, $"Error during clock in: {ex.Message}", "error");
        }
        finally
        {
            isClockingIn = false;
            
        }
    }

    private void ClockOut()
    {
        //basic clock out, implement check for actual clock out later
        clockedIn = false;
        StateHasChanged();
    }
}
