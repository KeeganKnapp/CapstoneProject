@using CapstoneBlazorApp.Services
@using MudBlazor
@using CapstoneBlazorApp.Services.Auth
@using CapstoneBlazorApp.Services.Abstractions
@using CapstoneBlazorApp.Models
@using CapstoneBlazorApp.Dtos
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.WebUtilities

@inject IAuthService AuthService
@inject NavigationManager Nav
@inject AbstractLoggerService Logger
@inject NavigationTracker NavigationTracker

@page "/login"
@rendermode InteractiveServer

<div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 80vh;">
        <div style="display: flex; flex-direction: column; align-items: center; gap: 16px; max-width: 300px; width: 100%;">
            <MudImage Src="/images/WorkFlow.png" Alt="Company Logo" Width="512" Class="mb-4" />
            <MudText Typo="Typo.h4" Color="Color.Primary" Style="margin-bottom: 16px;">Login</MudText>
            
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <MudAlert Severity="Severity.Error" Style="width: 100%;">@errorMessage</MudAlert>
            }
            
            <MudTextField 
                Label="Email" 
                Variant="Variant.Outlined" 
                Style="width: 100%;" 
                @bind-Value="_email" 
                Disabled="busy"
                Required="true" />
                
            <MudTextField 
                Label="Password" 
                Variant="Variant.Outlined" 
                InputType="InputType.Password" 
                Style="width: 100%;" 
                @bind-Value="_password" 
                Disabled="busy"
                Required="true" />
                
            <MudButton 
                Variant="Variant.Filled" 
                Color="Color.Primary" 
                Style="width: 100%;" 
                OnClick="HandleValidSubmit"
                Disabled="busy || string.IsNullOrWhiteSpace(_email) || string.IsNullOrWhiteSpace(_password)">
                @if (busy)
                {
                    <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true"/>
                    <MudText Class="ms-2">Logging in...</MudText>
                }
                else
                {
                    <text>Login</text>
                }
            </MudButton>
            
        </div>
    </div>

@code {
    private string _email = "";
    private string _password = "";
    private bool busy;
    private string? errorMessage;
    private string? returnUrl;

    protected override void OnInitialized()
    {
        var uri = Nav.ToAbsoluteUri(Nav.Uri);
        if (QueryHelpers.ParseQuery(uri.Query).TryGetValue("returnUrl", out var returnUrlValue))
        {
            returnUrl = returnUrlValue;
        }
    }

    private async Task HandleValidSubmit()
    {
        if (busy) return;
        busy = true;
        errorMessage = null;
        
        try
        {            var success = await AuthService.LoginAsync(_email, _password);
              if (success)
            {
                Logger.Log(this, "Login successful", "info");
                NavigationTracker.Push("/login");
                
                await Task.Delay(500);
                
                var targetUrl = returnUrl;
                // Redirect to return URL manager dashboard
                if (await AuthService.IsUserManagerAsync()){
                    targetUrl = !string.IsNullOrEmpty(returnUrl) ? returnUrl : "/manager-dashboard";
                } else {
                    targetUrl = !string.IsNullOrEmpty(returnUrl) ? returnUrl : "/employee-dashboard";
                }
               
                


                Logger.Log(this, $"Navigating to: {targetUrl}", "info");
                Nav.NavigateTo(targetUrl, false); 
            }
            else
            {
                errorMessage = "Invalid email or password. Please try again.";
                Logger.Log(this, "Login failed: Invalid credentials", "error");
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Login failed. Please try again.";
            Logger.Log(this, "Login failed: " + ex.Message, "error");
        }
        finally
        {
            busy = false;
            StateHasChanged();
        }
    }
}
