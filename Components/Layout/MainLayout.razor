@using MudBlazor
@using System.Linq
@using System.Runtime.CompilerServices
@using CapstoneBlazorApp.Services.Abstractions
@using CapstoneBlazorApp.Services
@using CapstoneBlazorApp.Components.Layout
@using Microsoft.AspNetCore.Components.Authorization
@inherits LayoutComponentBase
@inject AbstractLoggerService LoggerService  
@inject NavigationManager Nav
@inject NavigationTracker NavigationTracker
@inject IAuthService AuthService
@inject AuthenticationStateProvider AuthStateProvider
@namespace CapstoneBlazorApp.Components.Layout

<MudThemeProvider @bind-IsDarkMode="@_isDarkMode" Theme="_theme"/>
<MudDialogProvider />
<MudSnackbarProvider/>
<MudPopoverProvider /> 

<MudLayout>    
        <MudAppBar Color="Color.Primary" Elevation="0">
            @if(NavigationTracker.Count > 0) {
                <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" 
                             Color="Color.Secondary" 
                             Class="me-2"
                             OnClick="GoBack"
                             Title="Go Back" />
            }
            <MudText Typo="Typo.h6" Class="ml-3">Capstone App</MudText>
            <MudSpacer />
            
            <AuthorizeView>
                <Authorized>
                    <MudText Typo="Typo.body2" Class="mr-3">Welcome, @context.User.Identity?.Name</MudText>                    <MudIconButton Color="Color.Inherit" Icon="@Icons.Material.Filled.Dashboard" 
                                   OnClick="@(() => Nav.NavigateTo("/employee-dashboard"))" 
                                   Title="Employee Dashboard" />                    <MudIconButton Color="Color.Inherit" Icon="@Icons.Material.Filled.AdminPanelSettings" 
                                   OnClick="@(() => NavigateToManager())" 
                                   Title="Manager Dashboard" />
                    <MudIconButton Color="Color.Inherit" Icon="@Icons.Material.Filled.Logout" 
                                   OnClick="HandleLogout" 
                                   Title="Logout" />
                </Authorized>
                <NotAuthorized>
                    <MudIconButton Color="Color.Inherit" Icon="@Icons.Material.Filled.Login" 
                                   OnClick="@(() => Nav.NavigateTo("/login"))" 
                                   Title="Login" />
                </NotAuthorized>
            </AuthorizeView>
            
            <MudIconButton Color="Color.Inherit" Icon="@Icons.Material.Filled.DarkMode" OnClick="ToggleDarkMode" />

        </MudAppBar>


    <MudMainContent Style="height: 100vh; overflow: hidden;">
    @if (_isDebug) {
        <MudExpansionPanels>
            <MudExpansionPanel Text="Debug Log">
            <div style="max-height: 300px; overflow-y: auto;">
                <MudList T="string" Dense="true">
                    @foreach (var log in logMessages)
                    {
                        <MudListItem T="string">
                            <MudText Typo="Typo.body2">@log</MudText>
                        </MudListItem>
                    }
                </MudList>
            </div>
            </MudExpansionPanel>
        </MudExpansionPanels>
    }
        @Body
    </MudMainContent>
</MudLayout>

@code {
    private bool _isDarkMode = false;
    private bool _isDebug = true; // Set to false to show the app bar
    
    private List<string> logMessages = new List<string>();
    private readonly MudTheme _theme = new()
    {
        PaletteLight = new PaletteLight
        {
            Primary = "#1976D2",
            Secondary = "#303F9F",
            Background = "#FAFAFA",
            Surface = "#FFFFFF",
            AppbarBackground = "#1976D2",
            TextPrimary = "#212121",
            TextSecondary = "#757575"
        },
        PaletteDark = new PaletteDark
        {
            Primary = "#BB86FC",
            Secondary = "#03DAC6",
            Background = "#121212",
            Surface = "#1E1E1E",
            AppbarBackground = "#1E1E1E",
            TextPrimary = "#FFFFFF",
            TextSecondary = "#ECEFF1"
        }
    };

    protected override async Task OnInitializedAsync() {
        LoggerService.OnLogMessage += OnLog;
        LoggerService.Log(this, "MainLayout initialized", "info");
        await base.OnInitializedAsync();
    }

    void OnLog(object? sender, string message)
    {
        logMessages.Add(message);
        StateHasChanged();
    }
    private void GoBack() {
        if(NavigationTracker.Count == 0) {
            Nav.NavigateTo("/");
            return;
        }
        Nav.NavigateTo(NavigationTracker.Pop());
    }
      private void ToggleDarkMode()
    {
        _isDarkMode = !_isDarkMode;
        StateHasChanged();
    }
      private async Task HandleLogout()
    {
        try
        {
            await AuthService.LogoutAsync();
            LoggerService.Log(this, "User logged out successfully", "info");
            Nav.NavigateTo("/login", true);
        }
        catch (Exception ex)
        {
            LoggerService.Log(this, "Logout failed: " + ex.Message, "error");
        }
    }

    private void NavigateToManager()
    {
        // Push current location to navigation tracker so user can go back
        NavigationTracker.Push(Nav.Uri);
        NavigationTracker.ButtonLabel = "Back to Dashboard";
        Nav.NavigateTo("/manager-dashboard");
    }
}
