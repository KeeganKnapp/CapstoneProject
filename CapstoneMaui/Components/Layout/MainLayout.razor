@using MudBlazor
@using System.Linq
@using System.Runtime.CompilerServices
@using CapstoneMaui.Core.Services.Abstractions
@using CapstoneMaui.Services
@inherits LayoutComponentBase
@inject AbstractLoggerService LoggerService  
@inject NavigationManager Nav
@inject NavigationTracker NavigationTracker
@namespace CapstoneMaui.Components.Layout

    <MudThemeProvider @bind-IsDarkMode="@_isDarkMode" Theme="_theme"/>
    <MudDialogProvider />
    <MudSnackbarProvider/>
    <MudPopoverProvider /> 
    <MudLayout>
            @if (_isDebug) {
            <MudExpansionPanels>
                <MudExpansionPanel Text="Debug Logs" Color="Color.Primary">
                    <MudList T="string" Items="_logMessages">
                        @foreach (var log in _logMessages.AsEnumerable().Reverse())
                        {
                            <MudListItem Text="@log" />
                        }
                    </MudList>
                </MudExpansionPanel>
            </MudExpansionPanels>
            }
            else {
        <MudAppBar Color="Color.Primary" Elevation="0">
            <MudIconButton Color="Color.Secondary" OnClick="GoBack" Icon="@Icons.Material.Filled.ArrowBack"/>
            <MudText Typo="Typo.h6" Class="ml-2">CapstoneMaui</MudText>
        </MudAppBar>
            }   


        <MudMainContent Style="overflow: hidden; margin: 16px; display: flex; flex-direction: column; height: 100%">
                @Body
        </MudMainContent>
    </MudLayout>

@code {
    private bool _isDarkMode = false;
    private bool _isDebug = false;
    private string backButtonLabel = "Back";
    private bool _isDebug = false;
    private List<string> _logMessages = new List<string>();
    private readonly MudTheme _theme = new()
    {
        PaletteLight = new PaletteLight
        {
            //construction company colors
            Primary = "#1976D2",
            Secondary = "#303F9F",
            Background = "#FFFFFF",
            Surface = "#FFFFFF",
            AppbarBackground = "#1976D2",
            DrawerBackground = "#F5F5F5",
            DrawerText = "#212121",
            TextPrimary = "#212121",
            TextSecondary = "#757575"

        },
        PaletteDark = new PaletteDark
        {
            //same thing just darker mode
            Primary = "#BB86FC",
            Secondary = "#03DAC6",
            Background = "#121212",
            Surface = "#1E1E1E",
            AppbarBackground = "#1E1E1E",
            DrawerBackground = "#1A1A1A",
            DrawerText = "#B0BEC5",
            TextPrimary = "#FFFFFF",
            TextSecondary = "#ECEFF1"
        }
        // You can add Typography/Layout later; keep defaults while stabilizing
    };


    protected override async Task OnInitializedAsync() {
        LoggerService.OnLogMessage += OnLog;
        LoggerService.Log(this, "MainLayout initialized", "info");
        await base.OnInitializedAsync();
    }

    private void GoBack() {
        if(NavigationTracker.Count == 0) {
            Nav.NavigateTo("/");
            return;
        }
        Nav.NavigateTo(NavigationTracker.Pop());
    }

    private void OnLog(object? sender, string message) {
        _logMessages.Add(message);
        if (_logMessages.Count > 20) {
            _logMessages.RemoveAt(0);
        }
        StateHasChanged();
    }
}
