@using CapstoneMaui.Core.Services.Abstractions
@using MudBlazor
@using MudBlazor.Components
@using CapstoneMaui.Core.Models
@inject AbstractLoggerService Logger
@inject AbstractLocationManager LocationManager
@namespace CapstoneMaui.Core.Components.Pages.Employee

@page "/employee-dashboard"

<MudStack AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Spacing="3" Style="height: 100%;">   

<MudSelect T="Guid" @bind-Value="selectedSite" Label="Select Job Site" Variant="Variant.Outlined">
    <MudSelectItem Value="@sites[0].Id">Downtown Construction Site</MudSelectItem>
    <MudSelectItem Value="@sites[1].Id">Uptown Renovation Project</MudSelectItem>
    <MudSelectItem Value="@sites[2].Id">Suburban Housing Development</MudSelectItem>
</MudSelect>

<ToDo/>

<MudCard Elevation="2" Style="height: 50vh; width: 90vw;">
    <MudCardContent Style="height: 100%;">
<JobSiteMap currentSiteId="@selectedSite" Sites="@sites" OnChanged="@HandleSiteChanged" />
    </MudCardContent>
</MudCard>

<MudText Typo="Typo.body1">Hours Worked: @hoursWorked</MudText>

@if (clockedIn)
{
    <MudButton Variant="Variant.Filled" FullWidth="true" Color="Color.Secondary" OnClick="ClockOut">
        Clock Out
    </MudButton>
}
else {
    <MudButton Variant="Variant.Filled" FullWidth="true" Color="Color.Primary" OnClick="ClockIn">
        Clock In
    </MudButton>
}
<MudStack Row="true" Justify="Justify.SpaceBetween">
    <MudIconButton Icon="@Icons.Material.Filled.Wallet" Color="Color.Info" Size="Size.Large" />
    <MudButton Variant="Variant.Filled">Request</MudButton>
    <MudIconButton Icon="@Icons.Material.Filled.Notifications" Color="Color.Warning" Size="Size.Large" />
</MudStack>

</MudStack>


@code {
    private bool clockedIn = false;

    private double currentLatitude = 47.6062;
    private double currentLongitude = -122.3321;

    private Guid selectedSite = Guid.Empty;
    public List<SiteDto> sites = new()
    {
        new SiteDto(Guid.NewGuid(), "Downtown Construction Site", 47.6062, -122.3321, 100),
        new SiteDto(Guid.NewGuid(), "Uptown Renovation Project", 47.6205, -122.3493, 150),
        new SiteDto(Guid.NewGuid(), "Suburban Housing Development", 47.5301, -122.0326, 200)
    };

   private void HandleSiteChanged(SiteDto site)
   {
       //handle site change
       SaveSite(this, site);
   }

   public void SaveSite(object? sender, SiteDto site)
   {
       //handle site change
       Logger.Log(this, $"Site changed to: {site.Name}");
  }

    private int hoursWorked = 0;
    private async Task ClockIn()
    {
        var site = sites.First(s => s.Id == selectedSite);
        Logger.Log(this,$"Attempting to clock in at location: {currentLatitude}, {currentLongitude}");
        //basic clock in, implement check for actual clock in later
        //check current location against job site
        if(selectedSite == Guid.Empty)
        {
            //no site selected
            Logger.Log(this, "No job site selected", "error");
            return;
        }
        if (await LocationManager.IsWithinRadiusAsync(site.Lat, site.Lng, site.RadiusMeters))
        {
            clockedIn = true;
            Logger.Log(this, "Clocked in successfully", "info");
        }
        else
        {
            Logger.Log(this, "Not within radius of job site", "error");
        }
    }

    private void ClockOut()
    {
        //basic clock out, implement check for actual clock out later
        clockedIn = false;
    }
}
